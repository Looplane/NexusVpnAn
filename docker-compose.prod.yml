version: '3.8'

# ==============================================================================
# NEXUSVPN - PRODUCTION DEPLOYMENT CONFIGURATION
# ==============================================================================
#
# OPTION 1: SELF-HOSTED (VPS / Dedicated Server / Hetzner)
# Use this file 'as is'. It spins up Nginx, Postgres, Backend, and Frontend.
# The Frontend talks to the Backend via the internal Docker network or public URL.
#
# OPTION 2: HYBRID / CLOUD (Vercel + Render + Neon)
# You generally DO NOT use this docker-compose file for Vercel/Render.
# Instead, you deploy the folders individually:
#   - Frontend -> Vercel (Set env VITE_API_URL=https://your-render-backend.com)
#   - Backend  -> Render/Railway (Set env DB_HOST=your-neon-db-url)
#   - Database -> Neon/Supabase (PostgreSQL)
#
# ==============================================================================

services:
  # --- Reverse Proxy (Nginx) ---
  # Handles SSL termination and routing in a self-hosted setup.
  nginx:
    image: nginx:alpine
    container_name: nexusvpn-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
      - frontend

  # --- Database ---
  # Remove this service if using a managed DB like Neon/Supabase/AWS RDS
  postgres:
    image: postgres:16-alpine
    container_name: nexusvpn-db
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER:-nexus}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secureprodpass}
      POSTGRES_DB: nexusvpn
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data

  # --- Backend API ---
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: nexusvpn-api
    restart: always
    env_file: .env.prod
    volumes:
      # Mount the SSH private key so the backend can connect to other VPS nodes
      # REQUIRED for managing remote WireGuard nodes via SSH
      - ./infrastructure/keys/id_rsa:/etc/nexusvpn/id_rsa:ro
    environment:
      NODE_ENV: production
      # If using Cloud DB, replace 'postgres' with full connection string
      DB_HOST: postgres 
      SSH_KEY_PATH: /etc/nexusvpn/id_rsa
    depends_on:
      - postgres

  # --- Frontend ---
  # Remove this service if deploying Frontend to Vercel/Netlify.
  # If Self-Hosting, ensure VITE_API_URL points to your domain (e.g. https://vpn.yourdomain.com/api)
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: nexusvpn-ui
    restart: always
    environment:
      # CRITICAL: This tells the frontend where the backend lives.
      # For Docker self-hosted with Nginx, use relative path '/api' or full domain.
      VITE_API_URL: https://${DOMAIN_NAME:-5.161.91.222}/api

volumes:
  postgres_data_prod:
